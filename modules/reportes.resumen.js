import { loadCalendario,loadLlamadas,canonPlan,canonCalls } from '../core/data.js'; import { nrmU,sum } from '../core/utils.js'; function key(g,w){return nrmU(g)+'|'+String(w||'');} function group(planRows,callRows){const planMap=new Map();planRows.forEach(p=>{const k=key(p.gestor,p.semana);planMap.set(k,(planMap.get(k)||0)+1)});const doneMap=new Map();callRows.forEach(d=>{const k=key(d.gestor,d.semana);doneMap.set(k,(doneMap.get(k)||0)+1)});const keys=new Set([...planMap.keys(),...doneMap.keys()]);const rows=[];keys.forEach(k=>{const[gestor,semana]=k.split('|');const plan=planMap.get(k)||0;const done=doneMap.get(k)||0;rows.push({gestor,semana,plan,done,cov:plan?done/plan*100:(done>0?100:0)})});rows.sort((a,b)=>nrmU(a.gestor).localeCompare(nrmU(b.gestor))||(+a.semana-+b.semana));return{rows,totalPlan:sum(rows.map(r=>r.plan)),totalDone:sum(rows.map(r=>r.done))}} const kpi=(t,v,id)=>`<div class='card'><div class='muted'>${t}</div><div style='font-size:28px;font-weight:700' id='${id||''}'>${v}</div></div>`; export default async function mount(root){root.innerHTML=`<div class='card'><h1>Reporte â€¢ Resumen (Semanal)</h1><span class='badge'>LLAMADAS v2.1.0</span></div><div class='kpis'>${kpi('A realizar (Itinerarios)',0,'kpiPlan')}${kpi('Realizadas (Llamadas)',0,'kpiDone')}${kpi('Llamadas (Total)',0,'kpiTotal')}</div><table class='table'><thead><tr><th>Gestor</th><th>Semana</th><th>A realizar</th><th>Realizadas</th><th>% Cobertura</th></tr></thead><tbody id='body'></tbody></table>`; const plan=canonPlan(await loadCalendario()); const calls=canonCalls(await loadLlamadas()); const grp=group(plan,calls); const tb=document.getElementById('body'); tb.innerHTML=grp.rows.map(r=>`<tr><td>${r.gestor}</td><td>${r.semana}</td><td>${r.plan}</td><td>${r.done}</td><td>${r.cov.toFixed(1)}%</td></tr>`).join(''); document.getElementById('kpiPlan').textContent=grp.totalPlan; document.getElementById('kpiDone').textContent=grp.totalDone; document.getElementById('kpiTotal').textContent=grp.totalDone; }